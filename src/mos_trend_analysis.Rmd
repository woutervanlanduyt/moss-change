---
title: "Analysis of moss change"
author: "Wouter Van Landuyt, Hans Van Calster"
date: "`r Sys.Date()`"
output: bookdown::html_document2
bibliography: moss-change.bib
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(
  echo = FALSE,
  dpi = 72,
  dev = "png")

#library(RODBC)
library(ggplot2)
#library(nlme)
#library(mgcv)
#library(lme4)
library(MASS)
#library(splines)
#library(stats)
library(vegan)
library(readxl)
library(rprojroot)
library(DHARMa)
library(tidyverse)
library(janitor)
library(inborutils)
library(inbodb) #remotes::install_github("inbo/inbodb", build_vignettes = TRUE)
source(find_root_file("src/functions.R",
                      criterion = is_git_root))
library(brms)
```

```{r}

con <- connect_inbo_dbase("D0021_00_userFlora")
mosdata <- get_florabank_taxon_ifbl_year_2(
  connection = con,
  starting_year = 1980, 
  ifbl_resolution = "4km-by-4km", 
  taxongroup = "Mossen", 
  collect = TRUE
)


ellenberg <- get_florabank_traits(
  connection = con, 
  trait_name = "Ellenb", 
  collect = TRUE)

substraat <- get_florabank_traits_2(con, 
                     trait_name = "Substraat klassen mossen", 
                     collect = TRUE) %>%
  filter(extra_omschrijving == "3")


taxa <- tbl(src = con, "tblTaxon")
rel_groep <- tbl(src = con, "relTaxonTaxonGroep")
taxongroep <- tbl(src = con, "tblTaxonGroep")

taxa <- taxa %>%
  inner_join(rel_groep %>%
               select(-ID),
             by = c("ID" = "TaxonID")) %>%
  inner_join(taxongroep %>%
               filter(Naam %in% c("Mossen")
                      ) %>%
               select(-Code),
             by =  c("TaxonGroepID" = "ID")
             ) %>%
  collect()




dbDisconnect(con)
rm(con)
```


```{r}
mosdata <- mosdata %>%
  inner_join(taxa %>%
               select(ID, taxongroep = Naam), 
             by = c("TaxonIDParent" = "ID"))
```

```{r}
ellenberg <- ellenberg %>%
  inner_join(mosdata %>%
               distinct(TaxonIDParent),
             by = c("TaxonID" = "TaxonIDParent"))
```


```{r}
mosdata <- mosdata %>%
  clean_names()
ellenberg <- ellenberg %>%
  clean_names()
taxa <- taxa %>%
  clean_names()
```

```{r eval=!file.exists(find_root_file("data/taxa_gbif.csv", criterion = is_git_root))}
taxa_gbif <- taxa %>%
  select(id, code, naam_nederlands, naam_wetenschappelijk,
         taxn_vrs_key, taxongroep = naam) %>%
  gbif_species_name_match(name = "naam_wetenschappelijk")
write_tsv(x = taxa_gbif, 
          path = find_root_file("data/taxa_gbif.csv", criterion = is_git_root))
```

```{r eval=file.exists(find_root_file("data/taxa_gbif.csv", criterion = is_git_root))}
taxa_gbif <- read_tsv(file = find_root_file("data/taxa_gbif.csv", criterion = is_git_root))
```



```{r}
geobserveerde_taxa <- taxa_gbif %>%
  semi_join(mosdata %>%
               distinct(taxon_id_parent),
             by = c("id" = "taxon_id_parent"))
```

```{r}
mosdata <- mosdata %>%
  left_join(geobserveerde_taxa %>%
              select(id, phylum),
            by = c("taxon_id_parent" = "id"))
```

```{r}
vertaling_substraat <- read_csv2(
  find_root_file(
    "data/substraat_mossen.csv",
    criterion = is_git_root)
  )
```

# Exploratory data analysis


- Anthocerotophyta = hornworth = hauwmossen
- Bryophyta = bryophytes = bladmossen
- Marchantiophyta = liverworths = levermossen

```{r}
mosdata %>%
  group_by(phylum) %>%
  summarize(n_obs = n(),
            n_soorten = n_distinct(taxon_id_parent),
            n_hokken = n_distinct(ifbl_4by4)) %>%
  kable()
```


```{r}
mosdata %>%
  count(ifbl_4by4, jaar, name = "number of species") %>%
  ggplot() + 
  geom_density(aes(x = `number of species`, 
                     colour = factor(jaar))) + 
  ylab("density of ifbl 4 km x 4 km squares")
```

```{r}
mosdata %>%
  ggplot() + 
  geom_bar(aes(x = jaar, fill = phylum))
```


```{r}
species_freqs <- mosdata %>%
  filter(phylum != "Anthocerotophyta",
         !is.na(phylum)) %>%
  group_by(phylum) %>%
  mutate(n = n()) %>%
  group_by(phylum, taxon_id_parent) %>%
  summarise(
    n_obs = n(),
    prop_n_obs = n_obs/n[1],
    n_jaren = n_distinct(jaar),
    n_hokken = n_distinct(ifbl_4by4))
```


```{r}
species_freqs %>%
  ggplot() +
  geom_histogram(aes(x = prop_n_obs)) + 
  ylab("number of species") +
  facet_wrap(~phylum, scales = "free", ncol = 2)
```



```{r}
species_freqs %>%
  ggplot() +
  geom_histogram(aes(x = n_obs)) + 
  ylab("number of species") +
  facet_wrap(~phylum, scales = "free", ncol = 2)
```




```{r}
analyse_data <- mosdata %>%
  filter(jaar != max(jaar)) %>%
  filter(phylum %in% c("Bryophyta", "Marchantiophyta")) %>%
  mutate(periode = ifelse(between(jaar, 1980, 1999),
                          "1980-1999", 
                          "2000-2019"))
```

```{r}
analyse_data %>%
  count(ifbl_4by4, periode, name = "number of species") %>%
  ggplot() + 
  geom_density(aes(x = `number of species`, 
                     colour = periode)) + 
  ylab("density of ifbl 4 km x 4 km squares") +
  geom_vline(xintercept = 40)
```


```{r}
analyse_data_telfer <- analyse_data %>%
  distinct(ifbl_4by4, taxon_id_parent, periode, phylum) %>%
  mutate(value = 1) %>%
  pivot_wider(id_cols = c(ifbl_4by4, taxon_id_parent, phylum),
              names_from = periode, 
              values_from = value, 
              values_fill = list(value = 0)) %>%
  group_by(ifbl_4by4) %>%
  filter(sum(`2000-2019`) >= 40,
         sum(`1980-1999`) >= 40) %>%
  ungroup() %>%
  pivot_longer(cols = c(`2000-2019`, `1980-1999`), 
               names_to = "periode", 
               values_to = "values") %>%
  filter(values == 1) %>%
  select(-values)

```

```{r}
analyse_data_telfer_agg <- analyse_data_telfer %>%
  group_by(periode) %>%
  mutate(n_hok_tot = n_distinct(ifbl_4by4)) %>%
  count(periode, phylum, taxon_id_parent, n_hok_tot, 
        name = "n_hok") %>%
  ungroup() %>%
  # remove species that occur in less than 5 squares in period 1
  filter(!(n_hok < 5 & periode == "1980-1999"))
```


```{r}
analyse_data_telfer_agg <- analyse_data_telfer_agg %>%
  pivot_wider(id_cols = c(phylum, taxon_id_parent), 
              names_from = periode,
              values_from = c(n_hok, n_hok_tot), 
              values_fill = list(n_hok = 0)) %>%
  janitor::clean_names() %>%
  mutate(n_hok_tot_2000_2019 = ifelse(is.na(n_hok_tot_2000_2019),
                                        max(n_hok_tot_2000_2019,
                                            na.rm = TRUE),
                                        n_hok_tot_2000_2019),
         n_hok_tot_1980_1999 = ifelse(is.na(n_hok_tot_1980_1999),
                                        max(n_hok_tot_1980_1999,
                                            na.rm = TRUE),
                                        n_hok_tot_1980_1999),
         prop_baseline = (n_hok_1980_1999 + 1) / n_hok_tot_1980_1999,
         prop_2000_2019 = (n_hok_2000_2019 + 1) / n_hok_tot_2000_2019
         )
```


```{r}
# adding explanatory variables
ellenb_wide <- ellenberg %>%
  pivot_wider(id_cols = c(taxon_id), 
              names_from = kenmerk, 
              values_from = rekenwaarde) %>%
  select(taxon_id, 
         ell_l = `Ellenberg Licht`,
         ell_n = `Ellenberg Stikstof`,
         ell_f = `Ellenberg Vocht`,
         ell_r = `Ellenberg Reactiegetal`
         , ell_t = `Ellenberg Temperatuur`
         )


analyse_data_telfer_agg <- analyse_data_telfer_agg %>%
  left_join(ellenb_wide, 
            by = c("taxon_id_parent" = "taxon_id")) %>%
  # warning! species can have more than one substrate -> Wouter already selected 
  # most important one, but this should be coded in the script?
  left_join(substraat %>% 
              clean_names() %>%
              select(taxon_id, substraat = omschrijving) %>%
              inner_join(vertaling_substraat, 
                         ) %>%
              select(-substraat),
            by = c("taxon_id_parent" = "taxon_id")
            )
```


```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, substrate, name = "number of species") %>%
  kable()
```


```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, ell_l, name = "number of species") %>%
  kable()
```

```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, ell_r, name = "number of species") %>%
  kable()
```


```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, ell_f, name = "number of species") %>%
  kable()
```


```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, ell_n, name = "number of species") %>%
  kable()
```


```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, ell_t, name = "number of species") %>%
  kable()
```

Only remove substrate levels with less than 5 species (for Ellenberg variables this is not necessary because they are included as continuous covariate).

```{r}
analyse_data_telfer_agg <- analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  group_by(phylum, substrate) %>%
  filter(n() > 5) %>%
  ungroup()
```


```{r}
analyse_data_telfer_agg %>%
  ungroup() %>%
  filter(phylum == "Bryophyta") %>%
  select(starts_with("ell")) %>%
  GGally::ggpairs(title = "Bryophyta")
```

```{r}
analyse_data_telfer_agg %>%
  ungroup() %>%
  filter(phylum != "Bryophyta") %>%
  select(starts_with("ell")) %>%
  GGally::ggpairs(title = "Marchantiophyta") 
```

```{r}
analyse_data_telfer_agg %>% 
  ggplot() + 
  geom_bar(aes(x = substrate, fill = phylum), 
           position = position_dodge(width = 1)) + 
  coord_flip()
```


```{r}
analyse_data_telfer_agg %>%
  count(phylum, substrate) %>%
  kable()
```

```{r eval=FALSE}
# not every species has one substrate
analyse_data_telfer_agg %>%
  count(phylum, taxon_id_parent) %>%
  filter(n > 1)
  
```




```{r plotlyfig, out.width="100%", out.height="5in"}
p <- analyse_data_telfer_agg %>%
  left_join(taxa_gbif %>%
              select(id, naam_wetenschappelijk),
            by = c("taxon_id_parent" = "id")) %>%
  ggplot() +
  geom_jitter(aes(x = prop_baseline,
                  y = prop_2000_2019,
                  text = naam_wetenschappelijk)) +
  geom_abline() +
  geom_smooth(aes(x = prop_baseline,
                  y = prop_2000_2019),
              method = "lm") +
  facet_wrap(~phylum) 

p %>% plotly::ggplotly()
```

```{r plotlyfiglogit, out.width="100%", out.height="5in"}
p <- analyse_data_telfer_agg %>%
  left_join(taxa_gbif %>%
              select(id, naam_wetenschappelijk),
            by = c("taxon_id_parent" = "id")) %>%
  ggplot() +
  geom_jitter(aes(x = qlogis(prop_baseline),
                  y = qlogis(prop_2000_2019),
                  text = naam_wetenschappelijk)) +
  geom_abline() +
  geom_smooth(aes(x = qlogis(prop_baseline),
                  y = qlogis(prop_2000_2019)),
              method = "lm") +
  facet_wrap(~phylum) 

p %>% plotly::ggplotly()
```


```{r}
analyse_data_telfer_agg %>%
  count(n_hok_1980_1999)

analyse_data_telfer_agg %>%
  count(n_hok_2000_2019)

```


```{r}
#Keeping only species that occur in both periods (much improves model validation).
#(Alternative could be to include a factor with levels for lost, persisting, gained #in the model to explain lost and gained species, but maybe see this as a separate #model with the full dataset!)
analyse_data_telfer_agg <- analyse_data_telfer_agg  %>%
      filter(n_hok_2000_2019 > 0,
             n_hok_1980_1999 > 0)  
```



# Methods

## Trends

To assess the changes in distribution of bryophyte species form 1980 until 2018 we divided the survey in two periods and compared the period 1980-1999 with the period 2000-2018. 
To minimize the effect of badly prospected grid cells we only used grid cells (16km²) where at least 40 species were found in both periods (Figure \@ref(fig:fig1)).

(ref:fig1) 16 km² grids of Flanders and the Brussels Capital Region with at least 40 species of Bryophytes recorded in both the period 1980-1999 and the period 2000-2019.

```{r fig1, out.width = "100%", fig.cap = "(ref:fig1)"}
include_graphics("figure_1.jpg")
```


This resulted in 224 grid cells prospected in both periods.
In these selected grid cells 35648 bryophyte observations (expressed as unique species per year and per 16 km² grid) were done in the first period and 45236 in the second period.
To correct for potential changes in survey effort within those grids we used a relative change index as proposed by @telfer2002, with slight modifications.

This method assumes that during the two surveys recorders attempted to observe as many species as possible in each grid cell.
The size of the distribution area of individual species in a given period, i.e., the number of 16 km² grid cells where the species was observed, was expressed as a proportion of the total number of grid cells studied during that period.
To summarise the changes in distribution area for all species, we modeled the number of occupied 16 km² squares in the second survey (out of the total number of 16 km² squares considered, i.e. proportional data) as a function of the logit-transformed proportion in the first survey (baseline) and covariates (phylum, substrate and Ellenberg values).
Substrate effects were modeled for each phylum separately as random effects coming from a normal distribution with mean zero and an estimated standard deviation.
Because the counts were overdispersed (variance larger than Binomial distribution), a beta-binomial distribution was used to account for overdispersion and a logit-link was used to link the proportions to the linear predictor with the following model equation:



$$
g(\mu_{i,s2}) = (\beta_0 + \beta_1\log\frac{\mu_{i,s1}}{1-\mu_{i,s1}} + \beta_L\text{ell}_L + \dots)*\text{phylum}_k + \mathbf{b}_{o,j} + \mathbf{b}_{1,j}\text{phylum}_k
$$
where:

$$
\begin{aligned}
\mu_{i,s2} \equiv \mathbf{E}(Y_{i,s2}|\text{trials},\mathbf{b})&& \text{expected value}\\
g(\mu_{i,s2}) = \log\frac{\mu_{i,s2}}{1-\mu_{i,s2}} && \text{logit-link} \\
Y_{i,s2} \sim \text{BetaBinomial}(\mu_{i,s2}, \phi_{i,s2}) && \text{Beta-Binomial distribution}\\
\begin{bmatrix}\mathbf{b}_{o,j}\\ \mathbf{b}_{1,j}\end{bmatrix}\sim N(0,\Sigma) && \text{random intercept and slope}\\
\Sigma = \begin{bmatrix}\sigma^2_{0,j}&0\\0&\sigma^2_{1,j}\end{bmatrix} && \text{variance-covariance matrix}
\end{aligned}
$$



Species that occurred in less than five 16 km² grid cells in the first period were omitted form the analyses.
We also used only species that were present in both periods. 


A Bayesian hierarchical modeling procedure was used to calculate the posterior distribution for these parameters [@burkner2017] and we assumed non-informative priors.

We focused model selection on the Ellenberg terms only. 
All other effects were kept in the model.
First, interaction terms for Ellenberg-values with phylum for which the 95% confidence interval contained 0 were removed.
Next, main Ellenberg terms for which the 95% confidence interval contained 0 were removed.
The simplest model with the highest predictive accuracy based on leave-one-out cross validation [@vehtari2017] was selected.

After rearranging the model equation (for one phylum) and exponentiating the linear predictor, ignoring all random effects, we obtain the following odds-ratio:

$$
\frac{Odds_{\mu_{i,s2}}}{Odds^{\beta_1}_{\mu_{i,s1}}} = \exp(\beta_0 + \beta_L\text{ell}_L + \dots)
$$
which allows us to predict the effect of Ellenberg values on the relative increase or decrease of the Bryophytes.

In a similar way, substrate random effects are calculated from the posterior linear predictor, conditional on Ellenberg values fixed at their median values.
@gelman2012 point out that no correction for multiple comparisons are necessary when substrate effects are calculated in this way.

All analyses were done using the R language for statistical computing [@rcoreteam2020].

```{r betabinom}
beta_binomial2 <- custom_family(
  "beta_binomial2", dpars = c("mu", "phi"),
  links = c("logit", "log"), lb = c(NA, 0),
  type = "int", vars = "vint1[n]"
)
# T = number of trials
# mu = a / (a + b) = per trial probability
# phi = a + b = overdispersion parameter
stan_funs <- "
  real beta_binomial2_lpmf(int y, real mu, real phi, int T) {
    return beta_binomial_lpmf(y | T, mu * phi, (1 - mu) * phi);
  }
  int beta_binomial2_rng(real mu, real phi, int T) {
    return beta_binomial_rng(T, mu * phi, (1 - mu) * phi);
  }
"
stanvars <- stanvar(scode = stan_funs, block = "functions")
```


```{r full-model}
alt_telfer <- brm(n_hok_2000_2019 | vint(n_hok_tot_2000_2019) ~ 
                    qlogis(n_hok_1980_1999/n_hok_tot_1980_1999)
                  + phylum 
                  + qlogis(n_hok_1980_1999/n_hok_tot_1980_1999):phylum 
                  + (
                  + ell_l
                  #+ ell_r
                  + ell_n
                  + ell_f
                  + ell_t) * phylum 
                  + (1 + phylum || substrate) #no correlations modeled (if included, estimate was -1 to +1)
                  , 
    family = beta_binomial2,
    stanvars = stanvars,
    data = analyse_data_telfer_agg,
    file = "stanmodel_alt_telfer",
    file_refit = "on_change",
    save_pars = save_pars(all = TRUE),
    silent = 2,
    cores = 4)
```


```{r}
expose_functions(alt_telfer, vectorize = TRUE)

log_lik_beta_binomial2 <- function(i, prep) {
  mu <- prep$dpars$mu[, i]
  phi <- prep$dpars$phi
  trials <- prep$data$vint1[i]
  y <- prep$data$Y[i]
  beta_binomial2_lpmf(y, mu, phi, trials)
}

posterior_predict_beta_binomial2 <- function(i, prep, ...) {
  mu <- prep$dpars$mu[, i]
  phi <- prep$dpars$phi
  trials <- prep$data$vint1[i]
  beta_binomial2_rng(mu, phi, trials)
}

posterior_epred_beta_binomial2 <- function(prep) {
  mu <- prep$dpars$mu
  trials <- prep$data$vint1
  trials <- matrix(trials, nrow = nrow(mu), ncol = ncol(mu), byrow = TRUE)
  mu * trials
}
```


```{r model-selection}
alt_telfer_2 <- update(alt_telfer, 
                       .~. 
                       - ell_l:phylum 
                       - ell_n:phylum
                       - ell_f:phylum 
                      , file = "stanmodel_alt_telfer_2"
                      , file_refit = "on_change"
                      , save_pars = save_pars(all = TRUE)
                      , cores = 4)

alt_telfer_3 <- update(alt_telfer, 
                       .~. 
                       - ell_l 
                       - ell_l:phylum 
                       - ell_n 
                       - ell_n:phylum
                       - ell_f:phylum 
                      , file = "stanmodel_alt_telfer_3"
                      , file_refit = "on_change"
                      , save_pars = save_pars(all = TRUE)
                       , cores = 4)

loo1 <- loo(alt_telfer, alt_telfer_2, alt_telfer_3, 
            save_psis = TRUE,
            moment_match = TRUE) 
# the elpd_diff is more than 2 times larger than its standard erro 
```


# Results


## Model selection

```{r loo, warning=FALSE}
loo1$diffs %>%
  as.data.frame() %>%
  kable(caption = "Results of model comparisons. First row contains the model with the highest predictive accuracy. The best model contained an effect for Ellenberg moisture and a phylum specific effect for Ellenberg temperature in addition to the effects dealing with sampling effort and substrate.",
        digits = 2)
```


## Model diagnostics

```{r model-diagnostics, echo = TRUE}
plot(loo1$loos$alt_telfer, label_points = TRUE)
plot(loo1$loos$alt_telfer_3, label_points = TRUE)

alt_telfer_3$data[745,]
analyse_data_telfer_agg[745,]
taxa[taxa$id == 760, ] 
#Boomfranjemos looks like an outlying observation
#it is the only epiphytic liverworth on living wood that declines strongly:
analyse_data_telfer_agg %>%
  filter(substrate == "epiphytic on living wood",
         phylum == "Marchantiophyta")
```


## Model summary of best predictive model

```{r}
broom.mixed::tidy(alt_telfer_3) %>%
  kable()
```

<!--
From Telfer et al (2002) $\text{logit}(P_2k) = a + b \text{logit}(P_1k) + Z_k$:
> The intercept _a_ measures change in recording probability(on a logit scale) and the slope _b_ measures the extent to which that change depends on the recording probability in the first survey. Parameters _a_ and _b_ may include the effects both of biological change and of change in recorder behaviour.
-->

## Model visualisation

```{r predictions-random-effects-substrate}
pp_substrate <- function(model,
                         odds_ratio = TRUE) {
  nd <- model$data %>%
    summarise(across(starts_with(c("n_hok_tot", "n_hok_19", "ell")), median)) %>%
    expand_grid(
      unique(analyse_data_telfer_agg[,c("phylum", "substrate")]))
  
  ps <- posterior_samples(
    model, 
    pars = c("b_Intercept",
             "b_phylum",
             "b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999"))
  
  
  #Bryophyta
  indices <- which(nd$phylum=="Bryophyta")
  lineartrend_bryo <- 
    #ps$b_Intercept + 
    ps$b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999 %*%
    t(qlogis(nd$n_hok_1980_1999/nd$n_hok_tot_1980_1999)[indices])
  lineartrend_bryo_incl_intercept <- 
    ps$b_Intercept + 
    ps$b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999 %*%
    t(qlogis(nd$n_hok_1980_1999/nd$n_hok_tot_1980_1999)[indices])
  # Marchantiophyta
  indices <- which(nd$phylum=="Marchantiophyta")
  lineartrend_marc <- 
    #ps$b_Intercept + ps$b_phylumMarchantiophyta +
    (ps$b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999 +
       ps$`b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999:phylumMarchantiophyta`) %*%
    t(qlogis(nd$n_hok_1980_1999/nd$n_hok_tot_1980_1999)[indices])
  lineartrend_marc_incl_intercept <- 
    ps$b_Intercept + ps$b_phylumMarchantiophyta +
    (ps$b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999 +
       ps$`b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999:phylumMarchantiophyta`) %*%
    t(qlogis(nd$n_hok_1980_1999/nd$n_hok_tot_1980_1999)[indices])
  
  lineartrend <- cbind(lineartrend_bryo, lineartrend_marc)
  
  lineartrend_incl_intercept <- cbind(
    lineartrend_bryo_incl_intercept, 
    lineartrend_marc_incl_intercept
  )
  
  
  logit_s2 <- posterior_linpred(model, newdata = nd)
    
  
  if (odds_ratio) {
    # calculate as odds-ratio
    #########################
    log_odds_ratio_s2_s1 <- logit_s2 - lineartrend
    odds_ratio_s2_s1 <- exp(log_odds_ratio_s2_s1)
    pp_summary <- nd %>%  
      mutate(
        median = apply(odds_ratio_s2_s1, 2, "median"),
        lwr = apply(odds_ratio_s2_s1, 2, "quantile", probs = 0.025),
        upr = apply(odds_ratio_s2_s1, 2, "quantile", probs = 0.975),
      )
    return(pp_summary)
    
  } else {
    # calculate difference based on linear predictor (in logit-scale)
    logit_s2_minus_s1 <- logit_s2 - lineartrend_incl_intercept
    pp_summary_linear_diff <- nd %>%
      mutate(
        median = apply(logit_s2_minus_s1, 2, "median"),
        lwr = apply(logit_s2_minus_s1, 2, "quantile", probs = 0.025),
        upr = apply(logit_s2_minus_s1, 2, "quantile", probs = 0.975),
      )
    return(pp_summary_linear_diff)
  }
}

```

```{r plot-odds-ratio-random-effects-substrate, out.width="100%"}
pp_substrate(model = alt_telfer_3, 
           odds_ratio = TRUE) %>%
  group_by(phylum) %>%
  mutate(substrate = reorder(substrate, median)) %>%
  ggplot(aes(x = substrate, y = median, colour = phylum)) + 
  geom_hline(yintercept = 1) +
  geom_pointrange(aes(ymin = lwr, 
                    ymax = upr),
                position = position_dodge(width = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_y_continuous(
    breaks = c( 0.5, 0.75, 1, 4/3, 2),
    labels = scales::percent) + 
  coord_trans(y = "log") + 
  labs(y = "odds-ratio of survey 2000-2019\n to survey 1980-1999")
  
```


```{r plot-lineardifference-random-effects-substrate, out.width="100%"}
pp_substrate(model = alt_telfer_3, odds_ratio = FALSE) %>%
  group_by(phylum) %>%
  mutate(substrate = reorder(substrate, median)) %>%
  ggplot(aes(x = substrate, y = median, colour = phylum)) + 
  geom_hline(yintercept = 0) +
  geom_pointrange(aes(ymin = lwr, 
                    ymax = upr),
                position = position_dodge(width = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_y_continuous() + 
  labs(y = "Difference in logit-scale of survey 2000-2019\n to survey 1980-1999")

```



```{r function-fixed-effects-ellenberg}
pp_ellenberg <- function(data = analyse_data_telfer_agg,
                         model,
                         ellenberg = "ell_l",
                         ellenberg_name = "Light",
                         odds_ratio = TRUE) {
  assertthat::assert_that(any(ellenberg %in% colnames(model$data)))
  nd <- data %>%
    summarise(across(starts_with(c("n_hok_tot", "n_hok_19", "ell")), median)) %>%
    select(-all_of(ellenberg)) %>%
    expand_grid(
      data %>%
        group_by(phylum) %>%
        select(all_of(ellenberg)) %>%
        distinct()
    ) %>%
    mutate(substrate = NA)
  
  ps <- posterior_samples(
    model, 
    pars = c("b_Intercept",
             "b_phylum",
             "b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999"))
  
  if (odds_ratio) {
    #Bryophyta
    indices <- which(nd$phylum=="Bryophyta")
    lineartrend_bryo <- 
      #ps$b_Intercept + 
      ps$b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999 %*%
      t(qlogis(nd$n_hok_1980_1999/nd$n_hok_tot_1980_1999)[indices])
    # Marchantiophyta
    indices <- which(nd$phylum=="Marchantiophyta")
    lineartrend_marc <- 
      #ps$b_Intercept + ps$b_phylumMarchantiophyta +
      (ps$b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999 +
         ps$`b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999:phylumMarchantiophyta`) %*%
      t(qlogis(nd$n_hok_1980_1999/nd$n_hok_tot_1980_1999)[indices])
    
    lineartrend <- cbind(lineartrend_bryo, lineartrend_marc)
    logit_s2 <- posterior_linpred(model, newdata = nd, re_formula = NA)
    log_odds_ratio_s2_s1 <- logit_s2 - lineartrend 
    odds_ratio_s2_s1 <- exp(log_odds_ratio_s2_s1)
    pp_summary <- nd %>%  
      mutate(
        median = apply(odds_ratio_s2_s1, 2, "median"),
        lwr = apply(odds_ratio_s2_s1, 2, "quantile", probs = 0.025),
        upr = apply(odds_ratio_s2_s1, 2, "quantile", probs = 0.975),
      )
    
    from <- min(nd[,ellenberg])
    to <- max(nd[,ellenberg])
    
    pp_summary %>%
      mutate(x_ellenberg = ellenberg,
             name_ellenberg = ellenberg_name) %>%
      rename("ellenberg_values" = ellenberg)
  } else {
    #Bryophyta
    indices <- which(nd$phylum=="Bryophyta")
    lineartrend_bryo <- 
      ps$b_Intercept + 
      ps$b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999 %*%
      t(qlogis(nd$n_hok_1980_1999/nd$n_hok_tot_1980_1999)[indices])
    # Marchantiophyta
    indices <- which(nd$phylum=="Marchantiophyta")
    lineartrend_marc <- 
      ps$b_Intercept + ps$b_phylumMarchantiophyta +
      (ps$b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999 +
         ps$`b_qlogisn_hok_1980_1999Dn_hok_tot_1980_1999:phylumMarchantiophyta`) %*%
      t(qlogis(nd$n_hok_1980_1999/nd$n_hok_tot_1980_1999)[indices])
    
    lineartrend <- cbind(lineartrend_bryo, lineartrend_marc)
    logit_s2 <- posterior_linpred(model, newdata = nd, re_formula = NA)
    logit_s2_minus_s1 <- logit_s2 - lineartrend 
    pp_summary <- nd %>%  
      mutate(
        median = apply(logit_s2_minus_s1, 2, "median"),
        lwr = apply(logit_s2_minus_s1, 2, "quantile", probs = 0.025),
        upr = apply(logit_s2_minus_s1, 2, "quantile", probs = 0.975),
      )
    
    from <- min(nd[,ellenberg])
    to <- max(nd[,ellenberg])
    
    pp_summary %>%
      mutate(x_ellenberg = ellenberg,
             name_ellenberg = ellenberg_name) %>%
      rename("ellenberg_values" = ellenberg)
  }
}
```


```{r data-fixed-effects-ellenberg}
pp_moisture_or <- pp_ellenberg(model = alt_telfer_3, 
                               ellenberg = "ell_f", 
                            ellenberg_name = "Moisture")
pp_temperature_or <- pp_ellenberg(model = alt_telfer_3, ellenberg = "ell_t",
                                ellenberg_name = "Temperature")

pp_data_or <- bind_rows(
   pp_moisture_or, pp_temperature_or)


pp_moisture_ld <- pp_ellenberg(model = alt_telfer_3,
                               ellenberg = "ell_f", 
                            ellenberg_name = "Moisture",
                            odds_ratio = FALSE)
pp_temperature_ld <- pp_ellenberg(model = alt_telfer_3,
                                  ellenberg = "ell_t",
                                ellenberg_name = "Temperature",
                                odds_ratio = FALSE)

pp_data_ld <- bind_rows(
  pp_moisture_ld, pp_temperature_ld)


```


```{r plot-or-fixed-effects-ellenberg, out.width="100%"}
pp_data_or %>%
  ggplot(aes(x = ellenberg_values, y = median)) + 
  geom_hline(yintercept = 1) +
  geom_ribbon(aes(ymin = lwr, 
                  ymax = upr,
                  fill = phylum),
              alpha = 0.5) +
  geom_line(aes(colour = phylum)) +
  scale_y_continuous(
    breaks = c( 0.5, 0.75, 1, 4/3, 2),
    labels = scales::percent) + 
  coord_trans(y = "log") + 
  facet_wrap(~name_ellenberg, scales = "free_x") +
  scale_x_continuous("Ellenberg values",
                     breaks = function(x) 
                       unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
  labs(y = "odds-ratio of survey 2000-2019\n to survey 1980-1999")

```

```{r plot-ld-fixed-effects-ellenberg, out.width="100%"}
pp_data_ld %>%
  ggplot(aes(x = ellenberg_values, y = median)) + 
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = lwr, 
                  ymax = upr,
                  fill = phylum),
              alpha = 0.5) +
  geom_line(aes(colour = phylum)) +
  scale_y_continuous() + 
  facet_wrap(~name_ellenberg, scales = "free_x") +
  scale_x_continuous("Ellenberg values",
                     breaks = function(x) 
                       unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
  labs(y = "Difference in logit-scale of survey 2000-2019\n to survey 1980-1999")

```

# References


