---
title: "Analysis of moss change"
author: "Wouter Van Landuyt, Hans Van Calster"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(
  echo = FALSE)

#library(RODBC)
library(ggplot2)
#library(nlme)
#library(mgcv)
#library(lme4)
library(MASS)
#library(splines)
#library(stats)
library(vegan)
library(readxl)
library(rprojroot)
library(DHARMa)
library(tidyverse)
library(janitor)
library(inborutils)
library(inbodb) #remotes::install_github("inbo/inbodb", build_vignettes = TRUE)
source(find_root_file("src/functions.R",
                      criterion = is_git_root))
library(brms)
```

```{r}

con <- connect_inbo_dbase("D0021_00_userFlora")
mosdata <- get_florabank_taxon_ifbl_year_2(
  connection = con,
  starting_year = 1980, 
  ifbl_resolution = "4km-by-4km", 
  taxongroup = "Mossen", 
  collect = TRUE
)


ellenberg <- get_florabank_traits(
  connection = con, 
  trait_name = "Ellenb", 
  collect = TRUE)

substraat <- get_florabank_traits_2(con, 
                     trait_name = "Substraat klassen mossen", 
                     collect = TRUE) %>%
  filter(extra_omschrijving == "3")


taxa <- tbl(src = con, "tblTaxon")
rel_groep <- tbl(src = con, "relTaxonTaxonGroep")
taxongroep <- tbl(src = con, "tblTaxonGroep")

taxa <- taxa %>%
  inner_join(rel_groep %>%
               select(-ID),
             by = c("ID" = "TaxonID")) %>%
  inner_join(taxongroep %>%
               filter(Naam %in% c("Mossen")
                      ) %>%
               select(-Code),
             by =  c("TaxonGroepID" = "ID")
             ) %>%
  collect()




dbDisconnect(con)
rm(con)
```


```{r}
mosdata <- mosdata %>%
  inner_join(taxa %>%
               select(ID, taxongroep = Naam), 
             by = c("TaxonIDParent" = "ID"))
```

```{r}
ellenberg <- ellenberg %>%
  inner_join(mosdata %>%
               distinct(TaxonIDParent),
             by = c("TaxonID" = "TaxonIDParent"))
```


```{r}
mosdata <- mosdata %>%
  clean_names()
ellenberg <- ellenberg %>%
  clean_names()
taxa <- taxa %>%
  clean_names()
```

```{r eval=!file.exists(find_root_file("data/taxa_gbif.csv", criterion = is_git_root))}
taxa_gbif <- taxa %>%
  select(id, code, naam_nederlands, naam_wetenschappelijk,
         taxn_vrs_key, taxongroep = naam) %>%
  gbif_species_name_match(name = "naam_wetenschappelijk")
write_tsv(x = taxa_gbif, 
          path = find_root_file("data/taxa_gbif.csv", criterion = is_git_root))
```

```{r eval=file.exists(find_root_file("data/taxa_gbif.csv", criterion = is_git_root))}
taxa_gbif <- read_tsv(file = find_root_file("data/taxa_gbif.csv", criterion = is_git_root))
```



```{r}
geobserveerde_taxa <- taxa_gbif %>%
  semi_join(mosdata %>%
               distinct(taxon_id_parent),
             by = c("id" = "taxon_id_parent"))
```

```{r}
mosdata <- mosdata %>%
  left_join(geobserveerde_taxa %>%
              select(id, phylum),
            by = c("taxon_id_parent" = "id"))
```

```{r}
vertaling_substraat <- read_csv2(
  find_root_file(
    "data/substraat_mossen.csv",
    criterion = is_git_root)
  )
```

## Exploratory data analysis


- Anthocerotophyta = hornworth = hauwmossen
- Bryophyta = bryophytes = bladmossen
- Marchantiophyta = liverworths = levermossen

```{r}
mosdata %>%
  group_by(phylum) %>%
  summarize(n_obs = n(),
            n_soorten = n_distinct(taxon_id_parent),
            n_hokken = n_distinct(ifbl_4by4)) %>%
  kable()
```


```{r}
mosdata %>%
  count(ifbl_4by4, jaar, name = "number of species") %>%
  ggplot() + 
  geom_density(aes(x = `number of species`, 
                     colour = factor(jaar))) + 
  ylab("density of ifbl 4 km x 4 km squares")
```

```{r}
mosdata %>%
  ggplot() + 
  geom_bar(aes(x = jaar, fill = phylum))
```


```{r}
species_freqs <- mosdata %>%
  filter(phylum != "Anthocerotophyta",
         !is.na(phylum)) %>%
  group_by(phylum) %>%
  mutate(n = n()) %>%
  group_by(phylum, taxon_id_parent) %>%
  summarise(
    n_obs = n(),
    prop_n_obs = n_obs/n[1],
    n_jaren = n_distinct(jaar),
    n_hokken = n_distinct(ifbl_4by4))
```


```{r}
species_freqs %>%
  ggplot() +
  geom_histogram(aes(x = prop_n_obs)) + 
  ylab("number of species") +
  facet_wrap(~phylum, scales = "free", ncol = 2)
```



```{r}
species_freqs %>%
  ggplot() +
  geom_histogram(aes(x = n_obs)) + 
  ylab("number of species") +
  facet_wrap(~phylum, scales = "free", ncol = 2)
```


## Alternative Telfer method

<!--
Telfer methode op uurhok??
hoe is totaal aantal hokken bepaald?
hoe gevallen proportie 0 en 1 aangepakt?
waar is de analyse waarmee CIuurhok (= residuals van de Telfer analyse?) bepaald werd?
-->



```{r}
analyse_data <- mosdata %>%
  filter(jaar != max(jaar)) %>%
  filter(phylum %in% c("Bryophyta", "Marchantiophyta")) %>%
  mutate(periode = ifelse(between(jaar, 1980, 1999),
                          "1980-1999", 
                          "2000-2019"))
```

```{r}
analyse_data %>%
  count(ifbl_4by4, periode, name = "number of species") %>%
  ggplot() + 
  geom_density(aes(x = `number of species`, 
                     colour = periode)) + 
  ylab("density of ifbl 4 km x 4 km squares") +
  geom_vline(xintercept = 40)
```

Goed onderzocht = 40 of meer soorten in een uurhok per periode 

Uurhok moet in beide perioden goed onderzocht zijn.

```{r}
analyse_data_telfer <- analyse_data %>%
  distinct(ifbl_4by4, taxon_id_parent, periode, phylum) %>%
  mutate(value = 1) %>%
  pivot_wider(id_cols = c(ifbl_4by4, taxon_id_parent, phylum),
              names_from = periode, 
              values_from = value, 
              values_fill = list(value = 0)) %>%
  group_by(ifbl_4by4) %>%
  filter(sum(`2000-2019`) >= 40,
         sum(`1980-1999`) >= 40) %>%
  ungroup() %>%
  pivot_longer(cols = c(`2000-2019`, `1980-1999`), 
               names_to = "periode", 
               values_to = "values") %>%
  filter(values == 1) %>%
  select(-values)

```

```{r}
analyse_data_telfer_agg <- analyse_data_telfer %>%
  group_by(periode) %>%
  mutate(n_hok_tot = n_distinct(ifbl_4by4)) %>%
  count(periode, phylum, taxon_id_parent, n_hok_tot, 
        name = "n_hok") %>%
  ungroup() %>%
  # remove species that occur in less than 5 squares in period 1
  filter(!(n_hok < 5 & periode == "1980-1999"))
```


```{r}
analyse_data_telfer_agg <- analyse_data_telfer_agg %>%
  pivot_wider(id_cols = c(phylum, taxon_id_parent), 
              names_from = periode,
              values_from = c(n_hok, n_hok_tot), 
              values_fill = list(n_hok = 0)) %>%
  janitor::clean_names() %>%
  mutate(n_hok_tot_2000_2019 = ifelse(is.na(n_hok_tot_2000_2019),
                                        max(n_hok_tot_2000_2019,
                                            na.rm = TRUE),
                                        n_hok_tot_2000_2019),
         n_hok_tot_1980_1999 = ifelse(is.na(n_hok_tot_1980_1999),
                                        max(n_hok_tot_1980_1999,
                                            na.rm = TRUE),
                                        n_hok_tot_1980_1999),
         prop_baseline = (n_hok_1980_1999 + 1) / n_hok_tot_1980_1999,
         prop_2000_2019 = (n_hok_2000_2019 + 1) / n_hok_tot_2000_2019
         )
```


```{r}
# adding explanatory variables
ellenb_wide <- ellenberg %>%
  pivot_wider(id_cols = c(taxon_id), 
              names_from = kenmerk, 
              values_from = rekenwaarde) %>%
  select(taxon_id, 
         ell_l = `Ellenberg Licht`,
         ell_n = `Ellenberg Stikstof`,
         ell_f = `Ellenberg Vocht`,
         ell_r = `Ellenberg Reactiegetal`
         , ell_t = `Ellenberg Temperatuur`
         )


analyse_data_telfer_agg <- analyse_data_telfer_agg %>%
  left_join(ellenb_wide, 
            by = c("taxon_id_parent" = "taxon_id")) %>%
  # warning! species can have more than one substrate -> Wouter already selected 
  # most important one, but this should be coded in the script?
  left_join(substraat %>% 
              clean_names() %>%
              select(taxon_id, substraat = omschrijving) %>%
              inner_join(vertaling_substraat, 
                         ) %>%
              select(-substraat),
            by = c("taxon_id_parent" = "taxon_id")
            )
```


```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, substrate, name = "number of species") %>%
  kable()
```


```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, ell_l, name = "number of species") %>%
  kable()
```

```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, ell_r, name = "number of species") %>%
  kable()
```


```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, ell_f, name = "number of species") %>%
  kable()
```


```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, ell_n, name = "number of species") %>%
  kable()
```


```{r}
analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  count(phylum, ell_t, name = "number of species") %>%
  kable()
```

Only remove substrate levels with less than 5 species (for Ellenberg variables this is not necessary because they are included as continuous covariate).

```{r}
analyse_data_telfer_agg <- analyse_data_telfer_agg %>%
  filter(complete.cases(analyse_data_telfer_agg)) %>%
  group_by(phylum, substrate) %>%
  filter(n() > 5) %>%
  ungroup()
```


```{r}
analyse_data_telfer_agg %>%
  ungroup() %>%
  filter(phylum == "Bryophyta") %>%
  select(starts_with("ell")) %>%
  GGally::ggpairs(title = "Bryophyta")
```

```{r}
analyse_data_telfer_agg %>%
  ungroup() %>%
  filter(phylum != "Bryophyta") %>%
  select(starts_with("ell")) %>%
  GGally::ggpairs(title = "Marchantiophyta") 
```

```{r}
analyse_data_telfer_agg %>% 
  ggplot() + 
  geom_bar(aes(x = substrate, fill = phylum), 
           position = position_dodge(width = 1)) + 
  coord_flip()
```


```{r}
analyse_data_telfer_agg %>%
  count(phylum, substrate) %>%
  kable()
```

```{r eval=FALSE}
# not every species has one substrate
analyse_data_telfer_agg %>%
  count(phylum, taxon_id_parent) %>%
  filter(n > 1)
  
```




```{r}
p <- analyse_data_telfer_agg %>%
  left_join(taxa_gbif %>%
              select(id, naam_wetenschappelijk),
            by = c("taxon_id_parent" = "id")) %>%
  ggplot() +
  geom_jitter(aes(x = prop_baseline,
                  y = prop_2000_2019,
                  text = naam_wetenschappelijk)) +
  geom_abline() +
  geom_smooth(aes(x = prop_baseline,
                  y = prop_2000_2019)) +
  facet_wrap(~phylum) 

p %>% plotly::ggplotly()
```

```{r}
analyse_data_telfer_agg %>%
  count(n_hok_1980_1999)

analyse_data_telfer_agg %>%
  count(n_hok_2000_2019)

```

Keeping only species that occur in both periods (much improves model validation).
(Alternative could be to include a factor with levels for lost, persisting, gained in the model to explain lost and gained species, but maybe see this as a separate model with the full dataset!)

```{r}
analyse_data_telfer_agg <- analyse_data_telfer_agg  %>%
      filter(n_hok_2000_2019 > 0,
             n_hok_1980_1999 > 0)  
```


Overdispersion (residual deviance divided by residual degrees of freedom >> 1)! Quasi-binomial or beta-binomial model needed.

Should we include interaction between baseline proportion and substrate or ellenberg variables?

```{r full-model, eval=!file.exists("brmsfit_alt_telfer.rds")}
beta_binomial2 <- custom_family(
  "beta_binomial2", dpars = c("mu", "phi"),
  links = c("logit", "log"), lb = c(NA, 0),
  type = "int", vars = "vint1[n]"
)
stan_funs <- "
  real beta_binomial2_lpmf(int y, real mu, real phi, int T) {
    return beta_binomial_lpmf(y | T, mu * phi, (1 - mu) * phi);
  }
  int beta_binomial2_rng(real mu, real phi, int T) {
    return beta_binomial_rng(T, mu * phi, (1 - mu) * phi);
  }
"
stanvars <- stanvar(scode = stan_funs, block = "functions")

alt_telfer <- brm(n_hok_2000_2019 | vint(n_hok_tot_2000_2019) ~ 
                    qlogis(n_hok_1980_1999/n_hok_tot_1980_1999)
                  + phylum 
                  + qlogis(n_hok_1980_1999/n_hok_tot_1980_1999):phylum 
                  + (
                  + ell_l
                  #+ ell_r
                  + ell_n
                  + ell_f
                  + ell_t) * phylum 
                  + (1 + phylum | substrate)
                  , 
    family = beta_binomial2,
    stanvars = stanvars,
    data = analyse_data_telfer_agg,
    file = "stanmodel_alt_telfer"
    )

saveRDS(alt_telfer, file = "brmsfit_alt_telfer.rds")
```

```{r eval=file.exists("brmsfit_alt_telfer.rds")}
alt_telfer <- readRDS(file = "brmsfit_alt_telfer.rds")
```

```{r}
summary(alt_telfer)
```



```{r}
expose_functions(alt_telfer, vectorize = TRUE)

log_lik_beta_binomial2 <- function(i, prep) {
  mu <- prep$dpars$mu[, i]
  phi <- prep$dpars$phi
  trials <- prep$data$vint1[i]
  y <- prep$data$Y[i]
  beta_binomial2_lpmf(y, mu, phi, trials)
}

posterior_predict_beta_binomial2 <- function(i, prep, ...) {
  mu <- prep$dpars$mu[, i]
  phi <- prep$dpars$phi
  trials <- prep$data$vint1[i]
  beta_binomial2_rng(mu, phi, trials)
}

posterior_epred_beta_binomial2 <- function(prep) {
  mu <- prep$dpars$mu
  trials <- prep$data$vint1
  trials <- matrix(trials, nrow = nrow(mu), ncol = ncol(mu), byrow = TRUE)
  mu * trials
}
```


```{r random-effects-substrate}
nd <- analyse_data_telfer_agg %>%
  summarise(across(starts_with(c("n_hok_tot", "n_hok_19", "ell")), median)) %>%
  expand_grid(
    unique(analyse_data_telfer_agg[,c("phylum", "substrate")]))

logit_s2 <- posterior_linpred(alt_telfer, newdata = nd)
log_odds_ratio_s2_s1 <- sweep(
  logit_s2, 
  MARGIN = 2, 
  STATS = qlogis(nd$n_hok_1980_1999/nd$n_hok_tot_1980_1999),
  FUN = "-")
odds_ratio_s2_s1 <- exp(log_odds_ratio_s2_s1)
pp_summary <- nd %>%  
  mutate(
  median = apply(odds_ratio_s2_s1, 2, "median"),
  lwr = apply(odds_ratio_s2_s1, 2, "quantile", probs = 0.025),
  upr = apply(odds_ratio_s2_s1, 2, "quantile", probs = 0.975),
  )

pp_summary %>%
  group_by(phylum) %>%
  mutate(substrate = reorder(substrate, median)) %>%
  ggplot(aes(x = substrate, y = median, colour = phylum)) + 
  geom_hline(yintercept = 1) +
  geom_pointrange(aes(ymin = lwr, 
                    ymax = upr),
                position = position_dodge(width = 0.5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  scale_y_continuous(
    breaks = c( 0.5, 0.75, 1, 4/3, 2),
    labels = scales::percent) + 
  coord_trans(y = "log") + 
  labs(y = "odds-ratio of survey 2000-2019 to survey 1980-1999")
  
```


```{r fixed-effects-ellenberg, fig.width="100%", fig.height = 200/25.4, dpi = 300}
pp_ellenberg <- function(data = analyse_data_telfer_agg,
                           model = alt_telfer,
                           ellenberg = "ell_l",
                           ellenberg_name = "Light") {
  nd <- data %>%
    summarise(across(starts_with(c("n_hok_tot", "n_hok_19", "ell")), median)) %>%
    select(-all_of(ellenberg)) %>%
    expand_grid(
      data %>%
        group_by(phylum) %>%
        select(all_of(ellenberg)) %>%
        distinct()
    ) %>%
    mutate(substrate = NA)
  
  logit_s2 <- posterior_linpred(model, newdata = nd, re_formula = NA)
  log_odds_ratio_s2_s1 <- sweep(
    logit_s2, 
    MARGIN = 2, 
    STATS = qlogis(nd$n_hok_1980_1999/nd$n_hok_tot_1980_1999),
    FUN = "-")
  odds_ratio_s2_s1 <- exp(log_odds_ratio_s2_s1)
  pp_summary <- nd %>%  
    mutate(
      median = apply(odds_ratio_s2_s1, 2, "median"),
      lwr = apply(odds_ratio_s2_s1, 2, "quantile", probs = 0.025),
      upr = apply(odds_ratio_s2_s1, 2, "quantile", probs = 0.975),
    )
  
  from <- min(nd[,ellenberg])
  to <- max(nd[,ellenberg])
  
  pp_summary %>%
    mutate(x_ellenberg = ellenberg,
           name_ellenberg = ellenberg_name) %>%
    rename("ellenberg_values" = ellenberg)
    
}

pp_light <- pp_ellenberg()
pp_moisture <- pp_ellenberg(ellenberg = "ell_f", 
                             ellenberg_name = "Moisture")
pp_nitrogen <- pp_ellenberg(ellenberg = "ell_n", 
                             ellenberg_name = "Nitrogen")
pp_temperature <- pp_ellenberg(ellenberg = "ell_t",
                                ellenberg_name = "Temperature")

pp_data <- bind_rows(
  pp_light, pp_moisture, pp_nitrogen, pp_temperature)

pp_data %>%
  ggplot(aes(x = ellenberg_values, y = median)) + 
  geom_hline(yintercept = 1) +
  geom_ribbon(aes(ymin = lwr, 
                  ymax = upr,
                  fill = phylum),
              alpha = 0.5) +
  geom_line(aes(colour = phylum)) +
  scale_y_continuous(
    breaks = c( 0.5, 0.75, 1, 4/3, 2),
    labels = scales::percent) + 
  coord_trans(y = "log") + 
  facet_wrap(~name_ellenberg, scales = "free_x") +
  scale_x_continuous("Ellenberg values",
                     breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
  labs(y = "odds-ratio of survey 2000-2019\n to survey 1980-1999")
```


```{r substrate-model}
m_substrate <- glm(cbind(n_hok_2000_2019,
                        n_hok_tot_2000_2019 - n_hok_2000_2019) ~ 
                    qlogis((n_hok_1980_1999)/n_hok_tot_1980_1999)
                  + phylum 
                  + qlogis((n_hok_1980_1999)/n_hok_tot_1980_1999):phylum 
                  + substrate 
                  + phylum:substrate
                  , 
    family = "quasibinomial", 
    data = analyse_data_telfer_agg)


summary(m_substrate)
anova(m_substrate, test = "F") # for quasibinomial
```

```{r model-ellenberg}
m_ellenberg <- glm(cbind(n_hok_2000_2019,
                        n_hok_tot_2000_2019 - n_hok_2000_2019) ~ 
                    qlogis((n_hok_1980_1999)/n_hok_tot_1980_1999)
                  + phylum 
                  + qlogis((n_hok_1980_1999)/n_hok_tot_1980_1999):phylum 
                  + (ell_l
                  #+ ell_r
                  + ell_n
                  + ell_f
                  + ell_t) * phylum
                  , 
    family = "quasibinomial", 
    data = analyse_data_telfer_agg)

summary(m_ellenberg)

```

```{r eval=FALSE}
analyse_data_telfer_agg %>%
  mutate(residuals_model_substrate = residuals(m_substrate, type = "pearson"),
         residuals_model_ellenberg = residuals(m_ellenberg, type = "pearson")) %>%
  write_excel_csv2(path = find_root_file(
    "data",
    "analysis_data_residuals.csv",
    criterion = is_git_root))
```


```{r}
# model validation


#plot(m_ellenberg)
```

```{r}
calc_substrate <- function(model) {
  
  nd_r <- expand.grid(
    n_hok_1980_1999 = pretty(analyse_data_telfer_agg$n_hok_1980_1999,
                               n = 20),
    n_hok_tot_1980_1999 = 232) %>%
    expand_grid(
      unique(analyse_data_telfer_agg[,c("phylum", "substrate")]))
  
  prd_r <- predict(model, 
                   type = "link", 
                   newdata = nd_r, 
                   se = TRUE)
  
  pred_alt_telfer_r <- nd_r %>%
    bind_cols(data.frame(
      link_est = prd_r$fit,
      link_se = prd_r$se)) %>%
    mutate(link_lwr = qnorm(p = 0.025, link_est, link_se),
           link_upr = qnorm(p = 0.975, link_est, link_se),
           response_est = plogis(link_est),
           response_lwr = plogis(link_lwr),
           response_upr = plogis(link_upr),
           prop_baseline = (n_hok_1980_1999 + 1)/n_hok_tot_1980_1999)
  
  return(pred_alt_telfer_r)
}

calc_ellenberg <- function(ellenberg = "ell_l", model, data = analyse_data_telfer_agg) {
  stopifnot(ellenberg %in% names(model$model))
  ell <- c("ell_l", 
           #"ell_r", 
           "ell_f",
           "ell_n", 
           "ell_t")
  ell_fixed <- ell[ell != ellenberg]
  means <- map_dfc(data[,ell_fixed], mean)
  
  nd_r <- 
  expand.grid(
    n_hok_1980_1999 = pretty(data$n_hok_1980_1999,
                               n = 20),
    n_hok_tot_1980_1999 = 232,
    substrate = "Grond") %>%
    expand_grid(unique(data[,c("phylum", ellenberg)])) %>%
    filter(n_hok_1980_1999 > 0)
  
  nd_r <- nd_r %>%
    bind_cols(means)
  
  prd_r <- predict(model, 
                   type = "link", 
                   newdata = nd_r, 
                   se = TRUE)
  
  pred_alt_telfer_r <- nd_r %>%
    bind_cols(data.frame(
      link_est = prd_r$fit,
      link_se = prd_r$se)) %>%
    mutate(link_lwr = qnorm(p = 0.025, link_est, link_se),
           link_upr = qnorm(p = 0.975, link_est, link_se),
           response_est = plogis(link_est),
           response_lwr = plogis(link_lwr),
           response_upr = plogis(link_upr),
           prop_baseline = (n_hok_1980_1999 + 1)/n_hok_tot_1980_1999)
  
  return(pred_alt_telfer_r)
}


```

Models including substrate are rank-deficient and the fit may be misleading...


```{r substrate-prop}
calc_substrate(model = m_substrate) %>%
  filter(!is.na(link_est)) %>%
  ggplot(aes(x = prop_baseline, y = response_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = response_lwr, 
                      ymax = response_upr,
                      fill = substrate), 
              alpha = 0.3) + 
  geom_line(aes(colour = substrate)) +
  facet_wrap(~phylum)
```

Same figure but this time in link-scale (to obtain Telfer-like figures):

```{r substrate-link}
calc_substrate(model = m_substrate) %>%
  filter(!is.na(link_est)) %>%
  ggplot(aes(x = qlogis(prop_baseline), y = link_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = link_lwr, 
                      ymax = link_upr,
                      fill = substrate), 
              alpha = 0.3) + 
  geom_line(aes(colour = substrate)) +
  facet_wrap(~phylum)
```

```{r substrate-diff}
calc_substrate(model = m_substrate) %>%
  as_tibble() %>%
  mutate(link_est_diff = link_est - qlogis(prop_baseline),
         link_lwr_diff = link_lwr - qlogis(prop_baseline),
         link_upr_diff = link_upr - qlogis(prop_baseline)) %>% 
  filter(n_hok_1980_1999 %in% c(20, 100, 180)) %>%
  mutate(substrate = reorder(substrate, link_est_diff),
         n_hok_1980_1999 = factor(n_hok_1980_1999)) %>%
  ggplot(aes(x = substrate, y = link_est_diff)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_hline(yintercept = 0) +
  geom_pointrange(aes(ymin = link_lwr_diff, 
                    ymax = link_upr_diff,
                    colour = n_hok_1980_1999),
                position = position_dodge(width = 0.5)) +
  facet_grid(~phylum, scales = 'free_x') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
```


```{r ell-r-prop, eval=FALSE}
calc_ellenberg("ell_r", model = m_ellenberg) %>%
  ggplot(aes(x = prop_baseline, y = response_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = response_lwr, 
                      ymax = response_upr,
                      fill = factor(ell_r)), 
              alpha = 0.3) + 
  geom_line(aes(colour = factor(ell_r))) +
  facet_wrap(~phylum)
```


```{r ell-r-link, eval=FALSE}
calc_ellenberg("ell_r", model = m_ellenberg) %>%
  ggplot(aes(x = qlogis(prop_baseline), y = link_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = link_lwr, 
                  ymax = link_upr,
                  fill = factor(ell_r)), 
              alpha = 0.3) + 
  geom_line(aes(colour = factor(ell_r))) +
  facet_wrap(~phylum)
```


```{r ell-r-diff, eval=FALSE}
calc_ellenberg(ellenberg = "ell_r", model = m_ellenberg) %>%
  as_tibble() %>%
  mutate(link_est_diff = link_est - qlogis(prop_baseline),
         link_lwr_diff = link_lwr - qlogis(prop_baseline),
         link_upr_diff = link_upr - qlogis(prop_baseline)) %>% 
  filter(n_hok_1980_1999 %in% c(20, 100, 180)) %>%
  mutate(n_hok_1980_1999 = factor(n_hok_1980_1999)) %>%
  ggplot(aes(x = ell_r, y = link_est_diff)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = link_lwr_diff, 
                    ymax = link_upr_diff,
                    fill = n_hok_1980_1999),
              alpha = 0.3) +
  geom_line(aes(colour = n_hok_1980_1999)) +
  scale_x_continuous("Ellenberg Reaction number", breaks = seq(0, 12, 2)) +
  facet_grid(~phylum)
```


```{r ell-f-prop}
calc_ellenberg("ell_f", model = m_ellenberg) %>%
  ggplot(aes(x = prop_baseline, y = response_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = response_lwr, 
                      ymax = response_upr,
                      fill = factor(ell_f)), 
              alpha = 0.3) + 
  geom_line(aes(colour = factor(ell_f))) +
  facet_wrap(~phylum)
```


```{r ell-f-link}
calc_ellenberg("ell_f", model = m_ellenberg) %>%
  ggplot(aes(x = qlogis(prop_baseline), y = link_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = link_lwr, 
                      ymax = link_upr,
                      fill = factor(ell_f)), 
              alpha = 0.3) + 
  geom_line(aes(colour = factor(ell_f))) +
  facet_wrap(~phylum)
```

```{r ell-f-diff}
calc_ellenberg(ellenberg = "ell_f", model = m_ellenberg) %>%
  as_tibble() %>%
  mutate(link_est_diff = link_est - qlogis(prop_baseline),
         link_lwr_diff = link_lwr - qlogis(prop_baseline),
         link_upr_diff = link_upr - qlogis(prop_baseline)) %>% 
  filter(n_hok_1980_1999 %in% c(20, 100, 180)) %>%
  mutate(n_hok_1980_1999 = factor(n_hok_1980_1999)) %>%
  ggplot(aes(x = ell_f, y = link_est_diff)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = link_lwr_diff, 
                    ymax = link_upr_diff,
                    fill = n_hok_1980_1999),
              alpha = 0.3) +
  geom_line(aes(colour = n_hok_1980_1999)) +
  scale_x_continuous("Ellenberg Moisture", breaks = seq(0, 12, 2)) +
  facet_grid(~phylum)
```



```{r ell-l-prop}
calc_ellenberg("ell_l", model = m_ellenberg) %>%
  ggplot(aes(x = prop_baseline, y = response_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = response_lwr, 
                      ymax = response_upr,
                      fill = factor(ell_l)), 
              alpha = 0.3) + 
  geom_line(aes(colour = factor(ell_l))) +
  facet_wrap(~phylum)

```


```{r ell-l-link}
calc_ellenberg("ell_l", model = m_ellenberg) %>%
  ggplot(aes(x = qlogis(prop_baseline), y = link_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = link_lwr, 
                      ymax = link_upr,
                      fill = factor(ell_l)), 
              alpha = 0.3) + 
  geom_line(aes(colour = factor(ell_l))) +
  facet_wrap(~phylum)

```

```{r ell-l-diff}
calc_ellenberg(ellenberg = "ell_l", model = m_ellenberg) %>%
  as_tibble() %>%
  mutate(link_est_diff = link_est - qlogis(prop_baseline),
         link_lwr_diff = link_lwr - qlogis(prop_baseline),
         link_upr_diff = link_upr - qlogis(prop_baseline)) %>% 
  filter(n_hok_1980_1999 %in% c(20, 100, 180)) %>%
  mutate(n_hok_1980_1999 = factor(n_hok_1980_1999)) %>%
  ggplot(aes(x = ell_l, y = link_est_diff)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = link_lwr_diff, 
                    ymax = link_upr_diff,
                    fill = n_hok_1980_1999),
              alpha = 0.3) +
  geom_line(aes(colour = n_hok_1980_1999)) +
    scale_x_continuous("Ellenberg Light", breaks = seq(0, 12, 2)) +
  facet_grid(~phylum)
```


```{r ell-n-prop}
calc_ellenberg("ell_n", model = m_ellenberg) %>%
  ggplot(aes(x = prop_baseline, y = response_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = response_lwr, 
                      ymax = response_upr,
                      fill = factor(ell_n)), 
              alpha = 0.3) + 
  geom_line(aes(colour = factor(ell_n))) +
  facet_wrap(~phylum)

```




```{r ell-n-link}
calc_ellenberg("ell_n", model = m_ellenberg) %>%
  ggplot(aes(x = qlogis(prop_baseline), y = link_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = link_lwr, 
                      ymax = link_upr,
                      fill = factor(ell_n)), 
              alpha = 0.3) + 
  geom_line(aes(colour = factor(ell_n))) +
  facet_wrap(~phylum)

```

```{r ell-n-diff}
calc_ellenberg(ellenberg = "ell_n", model = m_ellenberg) %>%
  as_tibble() %>%
  mutate(link_est_diff = link_est - qlogis(prop_baseline),
         link_lwr_diff = link_lwr - qlogis(prop_baseline),
         link_upr_diff = link_upr - qlogis(prop_baseline)) %>% 
  filter(n_hok_1980_1999 %in% c(20, 100, 180)) %>%
  mutate(n_hok_1980_1999 = factor(n_hok_1980_1999)) %>%
  ggplot(aes(x = ell_n, y = link_est_diff)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = link_lwr_diff, 
                    ymax = link_upr_diff,
                    fill = n_hok_1980_1999),
              alpha = 0.3) +
  geom_line(aes(colour = n_hok_1980_1999)) +
  scale_x_continuous("Ellenberg Nitrogen", breaks = seq(0, 12, 2)) +
  facet_grid(~phylum)
```


```{r ell-t-prop}
calc_ellenberg("ell_t", model = m_ellenberg) %>%
  ggplot(aes(x = prop_baseline, y = response_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = response_lwr, 
                      ymax = response_upr,
                      fill = factor(ell_t)), 
              alpha = 0.3) + 
  geom_line(aes(colour = factor(ell_t))) +
  facet_wrap(~phylum)

```

```{r ell-t-link}
calc_ellenberg("ell_t", model = m_ellenberg) %>%
  ggplot(aes(x = qlogis(prop_baseline), y = link_est)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_abline() +
  geom_ribbon(aes(ymin = link_lwr, 
                      ymax = link_upr,
                      fill = factor(ell_t)), 
              alpha = 0.3) + 
  geom_line(aes(colour = factor(ell_t))) +
  facet_wrap(~phylum)

```


```{r ell-t-diff}
calc_ellenberg(ellenberg = "ell_t", model = m_ellenberg) %>%
  as_tibble() %>%
  mutate(link_est_diff = link_est - qlogis(prop_baseline),
         link_lwr_diff = link_lwr - qlogis(prop_baseline),
         link_upr_diff = link_upr - qlogis(prop_baseline)) %>% 
  filter(n_hok_1980_1999 %in% c(20, 100, 180)) %>%
  mutate(n_hok_1980_1999 = factor(n_hok_1980_1999)) %>%
  ggplot(aes(x = ell_t, y = link_est_diff)) + 
  #geom_point(data = analyse_data_telfer_agg,
  #           aes(y = prop_2000_2019,
  #               colour = substrate),
  #           alpha = 0.3) +
  geom_hline(yintercept = 0) +
  geom_ribbon(aes(ymin = link_lwr_diff, 
                    ymax = link_upr_diff,
                    fill = n_hok_1980_1999),
              alpha = 0.3) +
  geom_line(aes(colour = n_hok_1980_1999)) +
  scale_x_continuous("Ellenberg Temperature", breaks = seq(0, 12, 2)) +
  facet_grid(~phylum)
```
