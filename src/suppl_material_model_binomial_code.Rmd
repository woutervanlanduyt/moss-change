---
title: "Model description and code to reproduce analysis of changes in number of occupied grid cells for mosses and liverworths in Flanders, Belgium."
subtitle: "Supplementary material for 'Changes in the distribution of bryophytes in a highly urbanised region in Western Europe (Flanders, Belgium), a species traits analysis.'"
author: "Hans Van Calster, Wouter Van Landuyt"
date: "2021-10-29"
output: bookdown::html_document2
bibliography: references.bib
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(
  echo = TRUE,
  dpi = 72,
  dev = "png",
  out.width = "100%")

library(dplyr)
library(ggplot2)
library(readr)
library(brms)
library(patchwork)
library(here)
library(broom.mixed)
write_bib(c("base", "brms", "dplyr", "ggplot2", "readr", "patchwork", "here",
            "broom.mixed"),
          "references.bib")
write(x = 
"@Misc{stan2021,
    title = {Stan Modeling Language Users Guide and Reference Manual},
    author = {{Stan Development Team}},
    note = {Version 2.21.0},
    year = {2021},
    url = {http://mc-stan.org/},
  }
  
@article{gelman2012,
  title = {Why {{We}} ({{Usually}}) {{Don}}'t {{Have}} to {{Worry About Multiple Comparisons}}},
  author = {Gelman, Andrew and Hill, Jennifer and Yajima, Masanao},
  year = {2012},
  month = apr,
  volume = {5},
  pages = {189--211},
  issn = {1934-5747},
  doi = {10.1080/19345747.2011.618213},
  journal = {Journal of Research on Educational Effectiveness},
  keywords = {bayesian inference,bmkANA_MixedModels,hierarchical modeling,multiple comparisons,statis-,type s error},
  number = {2}
}",
file = "references.bib",
append = TRUE)
```

# Introduction

This R Markdown file (or the rendered html version) contains R code to reproduce the analyses presented in the paper 'Changes in the distribution of bryophytes in a highly urbanised region in Western Europe (Flanders, Belgium), a species traits analysis'.

All analyses were done using the R software language for statistical computing [@R-base].
The main R packages that are needed to run the code in this file are: `dplyr` [@R-dplyr], `ggplot2` [@R-ggplot2], `readr` [@R-readr], `brms` [@R-brms], `patchwork` [@R-patchwork], `here` [@R-here] and `broom.mixed` [@R-broom.mixed].
A full list of version and dependencies can be found at the end of the document in section [Session info](#-session-info).


# Read the data

Assuming the data are stored in a `data` subfolder of the project root folder.

```{r read-data, message=FALSE}
bryophyte_data <- read_csv(here("data/bryophyte_data.csv"))
taxon_names <- read_csv(here("data/taxon_names.csv"))
```

```{r glimpse-bryodat}
glimpse(bryophyte_data)
```

Explanation of variables:

- `phylum`: Character vector indicating to which phylum the species belongs.
- `taxon_id_parent`: Numeric identifier of a species. Can be used to join the table to `taxon_names` (join on `taxon_names$id`)
- `n_hok_1980_1999`: Number of occupied 16 km² squares in period 1980 - 1999.
- `n_hok_2000_2019`: Number of occupied 16 km² squares in period 2000 - 2019.
- `n_hok_tot_1980_1999`: Total number of eligible 16 km² squares in period 1980 - 1999.
- `n_hok_tot_2000_2019`: Total number of eligible 16 km² squares in period 2000 - 2019.
- `ell_l`: Ellenberg values for light.
- `ell_n`: Ellenberg values for nitrogen.
- `ell_f`: Ellenberg values for moisture.
- `ell_r`: Ellenberg values for reaction number.
- `ell_t`: Ellenberg values for temperature.
- `substrate`: Character vector indicating the substrate(s) where the species lives upon.
- `wei`: Weights used in the analysis to downweight species which have occur on more than one substrate.

```{r glimpse-taxa}
glimpse(taxon_names)
```


# Model fitting

We refer the reader to the methods section of the main paper for a full model description.
A Bayesian hierarchical modeling procedure was used to calculate the posterior distribution for the parameters of the model [@R-brms; @brms2017; @brms2018] and we assumed non-informative priors.
The `brms` package is an interface to the `Stan` programming language for statistical computation [@stan2021]. 

## Full model


Run the full model:

```{r full-model}
options(contrasts = c('contr.sum', 'contr.poly'))
full_model_binomial <- brm(n_hok_2000_2019 | trials(n_hok_tot_2000_2019) + weights(wei) ~ 
                    qlogis((n_hok_1980_1999+0.5)/(n_hok_tot_1980_1999+1))
                  + ell_l
                  + ell_n
                  + ell_f
                  + ell_t
                  + ell_l:phylum
                  + ell_n:phylum
                  + ell_f:phylum
                  + ell_t:phylum
                  + (1 + phylum || substrate), 
                  family = binomial(),
                  data = bryophyte_data,
                  file = "full_model_binomial",
                  file_refit = "on_change",
                  save_pars = save_pars(all = TRUE),
                  silent = 2,
                  cores = 4)
```

## Model selection

```{r}
model_zib_1 <- update(
  full_model_zib,
  bf(n_hok_2000_2019 | trials(n_hok_tot_2000_2019) + weights(wei) ~ 
       qlogis((n_hok_1980_1999+0.5)/(n_hok_tot_1980_1999+1))
     + ell_l
     + ell_n
     + ell_f
     + ell_t
     + ell_l:phylum
     + ell_n:phylum
     + ell_f:phylum
     + ell_t:phylum
     + (1 + phylum || substrate),
     zi ~ ell_l
     + ell_n
     + ell_f
     + ell_t
     + (1 + phylum || substrate))
  , file = "model_zib_1"
  , file_refit = "on_change"
  , save_pars = save_pars(all = TRUE)
  , cores = 4
  )

model_zib_2 <- update(
  model_zib_1,
  bf(n_hok_2000_2019 | trials(n_hok_tot_2000_2019) + weights(wei) ~ 
       qlogis((n_hok_1980_1999+0.5)/(n_hok_tot_1980_1999+1))
     + ell_l
     + ell_n
     + ell_f
     + ell_t
     + ell_l:phylum
     + ell_n:phylum
     + ell_f:phylum
     + ell_t:phylum
     + (1 + phylum || substrate),
     zi ~ ell_n
     + (1 + phylum || substrate))
  , file = "model_zib_2"
  , file_refit = "on_change"
  , save_pars = save_pars(all = TRUE)
  , cores = 4
  )

full_model_zib <- add_criterion(full_model_zib, "loo", 
                            moment_match = FALSE, 
                            overwrite = FALSE)

model_zib_1 <- add_criterion(model_zib_1, "loo", 
                            moment_match = FALSE,
                            overwrite = FALSE)

model_zib_2 <- add_criterion(model_zib_2, "loo", 
                            moment_match = FALSE,
                            overwrite = FALSE)

loo1 <- loo(full_model_zib, model_zib_1, model_zib_2) 
```



```{r loo, warning=FALSE}
loo1$diffs %>%
  as.data.frame() %>%
  kable(caption = "Results of model comparisons. First row contains the model with the highest predictive accuracy. The best model contained an effect for Ellenberg moisture and a phylum specific effect for Ellenberg nitrogen in addition to the effects dealing with sampling effort and substrate.",
        digits = 2)
```

## Model diagnostics


```{r model-diagnostics}
plot(loo1$loos$full_model_zib, label_points = TRUE)
```


```{r pp-check}
pp_check(full_model_zib, type = "bars", ndraws = 100)
```


## Model summary of best predictive model

```{r summary}
broom.mixed::tidy(full_model_zib) %>%
  kable()
```

# Model visualisation

We first define a helper function to create a `data.frame()` containing the values of variables to condition upon when visualising an effect of a variable of interest.

```{r create-conditions}
create_conditions <- function(x, vars, ...) {
    vars <- rev(as.character(vars))
    if (!is.data.frame(x) && "data" %in% names(x)) {
        x <- x$data
    }
    x <- as.data.frame(x)
    out <- brms:::named_list(vars)
    for (v in vars) {
        tmp <- get(v, x)
        if (brms:::is_like_factor(tmp)) {
            tmp <- levels(as.factor(tmp))
        }
        else {
            tmp <- mean(tmp, na.rm = TRUE)
        }
        out[[v]] <- tmp
    }
    out <- rev(expand.grid(out))
    out$cond__ <- rows2labels(out, ...)
    out
}
```



```{r conditions}
conditions0 <- create_conditions(
  x = full_model_zib,
  vars = c("n_hok_1980_1999", "ell_f", "ell_n", "ell_l", "ell_t")) %>%
  mutate(phylum = NA,
         n_hok_tot_2000_2019 = 227)

conditions1 <- create_conditions(
  x = full_model_zib,
  vars = c("ell_f", "ell_n", "ell_l", "ell_t")
  ) %>%
  mutate(phylum = NA,
         n_hok_tot_2000_2019 = 227)

conditions2 <- create_conditions(
  x = full_model_zib,
  vars = c("n_hok_1980_1999", "ell_f", "ell_l", "ell_t")
) %>%
  mutate(phylum = NA,
         n_hok_tot_2000_2019 = 227)


conditions3 <- create_conditions(
  x = full_model_zib,
  vars = c("n_hok_1980_1999", "ell_n", "ell_l", "ell_t")
) %>%
  mutate(phylum = NA,
         n_hok_tot_2000_2019 = 227)

conditions4 <- create_conditions(
  x = full_model_zib,
  vars = c("n_hok_1980_1999", "ell_n", "ell_f", "ell_t")
) %>%
  mutate(phylum = NA,
         n_hok_tot_2000_2019 = 227)

conditions5 <- create_conditions(
  x = full_model_zib,
  vars = c("n_hok_1980_1999", "ell_n", "ell_f", "ell_l")
) %>%
  mutate(phylum = NA,
         n_hok_tot_2000_2019 = 227)

```


(ref:plot-epred) Estimated total number of occupied cells. The total number of grid cells in both periods equals 228. Expectations and 95% confidence bounds or intervals are given. These expectations are conditional on `r conditions0$cond__` for variables other than the one on the x-axis (held constant to mean value). The black point with 95% confidence ranges in (a) represents the overall effect conditional on all other variables and is the reference against which change is calculated in (b, c and d). Black lines: line of no change. (a) Change in recording probability. (b) Effect of substrate on occurrence of mosses. (c) Effect of Ellenberg nitrogen values on occurrence of mosses. (d) Effect of Ellenberg moisture values on occurrence of mosses. 


The code chunk named `plot-epred` reproduces the Figure \@ref(fig:plot-epred) from the paper.

Substrate random effects are calculated from the posterior linear predictor, conditional on Ellenberg values and the number of occupied grid cells fixed at their mean values.
@gelman2012 point out that no correction for multiple comparisons are necessary when substrate effects are calculated in this way.


```{r plot-epred, fig.cap='(ref:plot-epred)', fig.height = 220/25.4, warning=FALSE}
pep0 <- posterior_epred(full_model_zib, 
                        re_formula = NA,
                        newdata = conditions0 %>% 
                          mutate(substrate = NA,
                                 n_hok_tot_2000_2019 = 227, 
                                 n_hok_tot_1980_1999 = 227
                          ))
pep0_conditions0 <- conditions0 %>%
  mutate(estimate__ = mean(pep0),
         lower__ = quantile(pep0, probs = 0.025),
         upper__  = quantile(pep0, probs = 0.975))



p1 <- conditional_effects(full_model_zib, 
                    effects = "n_hok_1980_1999",
                    conditions = conditions1)

p1 <- plot(p1, plot = FALSE, points = FALSE)[[1]] + 
  geom_point(data = full_model_zib$data,
             aes(x = n_hok_1980_1999 + 0.5, 
                 y = n_hok_2000_2019,
                 colour = phylum),
             alpha = 0.3,
             inherit.aes = FALSE) +
  geom_abline() +
  geom_pointrange(data = pep0_conditions0, 
                  aes(x = n_hok_1980_1999, 
                      y = estimate__,
                      ymin = lower__,
                      ymax = upper__), 
                inherit.aes = FALSE) +
  labs(y = "Number of occupied grid cells\n(2000 - 2019)",
       x = "Number of occupied grid cells (1980 - 1999)") +
  theme(legend.title = element_blank())

dt <- function(x) x - pep0_conditions0$estimate__
idt <- function(x) x + pep0_conditions0$estimate__

p2 <- conditional_effects(full_model_zib, 
                    effects = c("ell_n:phylum"),
                    conditions = conditions2)
p2[[1]] <- p2[[1]] %>%
  mutate(across(c(estimate__, lower__, upper__), dt))

p2 <- plot(p2, plot = FALSE, points = FALSE)[[1]] +
  geom_hline(data = pep0_conditions0 %>%
                mutate(estimate__ = dt(estimate__)), 
             aes(yintercept = estimate__), 
             inherit.aes = FALSE) +
 scale_x_continuous(
    breaks = function(x) 
      unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
  labs(y = "Change in number of\noccupied grid cells",
       x = "Ellenberg nitrogen values") +
  theme(legend.position = "none")

p3 <- conditional_effects(full_model_zib, 
                    effects = c("ell_f:phylum"),
                    conditions = conditions3)
p3[[1]] <- p3[[1]] %>%
  mutate(across(c(estimate__, lower__, upper__), dt))

# restrict range ell_f for Marchantiophyta to 4:11
p3$`ell_f:phylum` <- p3$`ell_f:phylum` %>%
  filter(!(phylum == "Marchantiophyta" & 
             (ell_f < 4 | ell_f > 11)))

p3 <- plot(p3, plot = FALSE, points = FALSE)[[1]] + 
  geom_hline(data = pep0_conditions0 %>%
                mutate(estimate__ = dt(estimate__)), 
             aes(yintercept = estimate__), 
             inherit.aes = FALSE) +
  scale_x_continuous(
    breaks = function(x) 
      unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
  labs(y = "Change in number of\noccupied grid cells",
       x = "Ellenberg moisture values") +
  theme(legend.position = "none")


p4 <- conditional_effects(full_model_zib, 
                          re_formula = NULL,
                          effects = c("substrate:phylum"),
                          conditions = conditions0)
p4[[1]] <- p4[[1]] %>%
  mutate(across(c(estimate__, lower__, upper__), dt))

p4 <- plot(p4, plot = FALSE, points = FALSE)[[1]] + 
  geom_hline(data = pep0_conditions0%>%
                mutate(estimate__ = dt(estimate__)), 
             aes(yintercept = estimate__), 
             inherit.aes = FALSE) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.x = element_blank(),
        legend.position = "none") +
  labs(y = "Change in number of\noccupied grid cells")

p5 <- conditional_effects(full_model_zib, 
                    effects = c("ell_l:phylum"),
                    conditions = conditions4)
p5[[1]] <- p5[[1]] %>%
  mutate(across(c(estimate__, lower__, upper__), dt))

p5 <- plot(p5, plot = FALSE, points = FALSE)[[1]] +
  geom_hline(data = pep0_conditions0 %>%
                mutate(estimate__ = dt(estimate__)), 
             aes(yintercept = estimate__), 
             inherit.aes = FALSE) +
 scale_x_continuous(
    breaks = function(x) 
      unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
  labs(y = "Change in number of\noccupied grid cells",
       x = "Ellenberg light values") +
  theme(legend.position = "none")

p6 <- conditional_effects(full_model_zib, 
                    effects = c("ell_t:phylum"),
                    conditions = conditions5)
p6[[1]] <- p6[[1]] %>%
  mutate(across(c(estimate__, lower__, upper__), dt))

p6 <- plot(p6, plot = FALSE, points = FALSE)[[1]] +
  geom_hline(data = pep0_conditions0 %>%
                mutate(estimate__ = dt(estimate__)), 
             aes(yintercept = estimate__), 
             inherit.aes = FALSE) +
 scale_x_continuous(
    breaks = function(x) 
      unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
  labs(y = "Change in number of\noccupied grid cells",
       x = "Ellenberg temperature values") +
  theme(legend.position = "none")


p1 + p4 + p2 + p3 + p5 + p6 +
  plot_layout(widths = c(1.1, 1), guides = "collect") + 
  plot_annotation(tag_levels = "a") &
  theme(text = element_text(size = 9))
```


# Session info

```{r sessioninfo}
sessioninfo::session_info()
```

# References